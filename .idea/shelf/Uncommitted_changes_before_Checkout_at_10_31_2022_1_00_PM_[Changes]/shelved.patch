Index: calendar.inc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?php\r\n/*\r\n * Copyright 2013 by Jerrick Hoang, Ivy Xing, Sam Roberts, James Cook, \r\n * Johnny Coster, Judy Yang, Jackson Moniaga, Oliver Radwan, \r\n * Maxwell Palmer, Nolan McNair, Taylor Talmage, and Allen Tucker. \r\n * This program is part of RMH Homebase, which is free software.  It comes with \r\n * absolutely no warranty. You can redistribute and/or modify it under the terms \r\n * of the GNU General Public License as published by the Free Software Foundation\r\n * (see <http://www.gnu.org/licenses/ for more information).\r\n * \r\n */\r\n\r\nsession_start();\r\nsession_cache_expire(30);\r\n?>\r\n<!--\r\n        calendar.inc\r\n        @author Max Palmer, Allen Tucker, Sam Roberts, James Cook\r\n        @version 3/26/08, revised 10/3/2013\r\n-->\r\n\r\n<?php\r\n\r\n/**\r\n * shows the \"previous week\"/\"next week\" menu, if the weeks exist\r\n */\r\nfunction do_week_nav($week, $edit, $venue) {\r\n    $cur_id = $week->get_id();\r\n//\t\techo (\"We are doing a nav for week \".$cur_id.\"<br>\");\r\n    $prev_id = date(\"y-m-d\", mktime(0, 0, 0, substr($cur_id, 3, 2), substr($cur_id, 6, 2) - 7, substr($cur_id, 0, 2))) . \":\" .$venue;\r\n    $next_id = date(\"y-m-d\", mktime(0, 0, 0, substr($cur_id, 3, 2), substr($cur_id, 6, 2) + 7, substr($cur_id, 0, 2))). \":\" .$venue;\r\n    $s = \"<p><table id=\\\"weeknav\\\" align=\\\"left\\\"><tr><td align=\\\"left\\\" >\";\r\n    // determines if there is a previous week\r\n    $prev_week = get_dbWeeks($prev_id);\r\n    if ($prev_week instanceof Week) {\r\n        $s = $s . '<a href=\"calendar.php?id=' . $prev_id . '&venue=' . $venue;\r\n        if ($edit)\r\n            $s = $s . \"&edit=true\";\r\n        $s = $s . \"\\\" id=\\\"weeknavlink\\\"><< Previous Week</a>\";\r\n    }\r\n    else $s = $s . \"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\";\r\n    if ($_SESSION['access_level'] >= 1)\r\n        if ($edit != true)\r\n            $s = $s . '<td align=\"left\"> <a href=\"calendar.php?id=' . $cur_id . '&venue=' . $venue . '&edit=true\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(edit this week)</a></td>';\r\n        else\r\n            $s = $s . '<td align=\"left\"> <a href=\"calendar.php?id=' . $cur_id . '&venue=' . $venue . '&edit=false\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(view this week)</a></td>';\r\n    if ($_SESSION['access_level'] >= 2)\r\n        $s = $s . '<td align=\"right\"> <a href=\"addWeek.php?archive=false&venue='.$venue.'\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(manage weeks)</a></td>';\r\n    $s = $s . \"</td><td align=\\\"right\\\">\";\r\n    // determines if there is a next week\r\n    $next_week = get_dbWeeks($next_id);\r\n    if ($next_week instanceof Week) {\r\n        $s = $s . '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"calendar.php?id=' . $next_id . '&venue=' . $venue;\r\n        if ($edit)\r\n            $s = $s . \"&edit=true\";\r\n        $s = $s . \"\\\" id=\\\"weeknavlink\\\">Next Week >></a>\";\r\n    }\r\n    else $s = $s . \"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\";\r\n    $s = $s . \"</td></tr></table></p><br><br>\";\r\n    return $s;\r\n}\r\nfunction show_week_no ($cur_id) {\r\n\t$cur_time = mktime(0, 0, 0, substr($cur_id, 3, 2), substr($cur_id, 6, 2), substr($cur_id, 0, 2));\r\n\t$woms = array(1=>\"1st\",2=>\"2nd\",3=>\"3rd\",4=>\"4th\",5=>\"5th\");\r\n\t$dom = date(\"d\",$cur_time);\r\n\t$wom = floor(($dom-1)/7) + 1;\r\n\t$weekno = date(\"W\",$cur_time);\r\n\tif ($weekno==53)   // one in 7 years will have a 53rd week, so punt when that happens\r\n \t\t$weekno==52;\r\n \t$weekno--;         // all years start at week 0 so we can't get 2 odds in a row\r\n \tif ($weekno%2==0)\r\n\t\t$oddeven = \"even\";\r\n\telse\r\n\t\t$oddeven = \"odd\";\r\n\treturn \" (week \". $weekno . \": \".$oddeven.\")\";\r\n\t//\techo $woms[$wom] . \" \". date (\"l\", $cur_time) . \" of the month<p>\";\r\n}\r\n/**\r\n * gets a week object, and displays it as a calendar\r\n */\r\nfunction show_week($days, $week, $edit, $year, $doy, $venue) {\r\n    // gets all of the dates for this week\r\n    // sets up the table, with title, and then day of month\r\n    $venues = array(\"portland\" => \"Portland House\", \"bangor\" => \"Bangor House\");\r\n\t$free_hour = array();\r\n    for ($i = 0; $i < 91; $i++)\r\n        $free_hour[] = true;\r\n//\t\techo (\"Showing week \". $week->get_id(). \" for venue \" . $venue . \" and first day \" . $days[0]->get_id() . \"<br>\");\r\n    $daynames = array(\"Monday\", \"Tuesday\", \"Wednesday\", \"Thursday\", \"Friday\", \"Saturday\", \"Sunday\");\r\n    echo ('<table id=\"calendar\" align=\"center\" ><tr class=\"weekname\"><td colspan=\"16\" ' .\r\n    'align=\"center\" >Calendar: ' . $week->get_name() . '</td></tr>\r\n\t\t\t\t<tr><td bgcolor=lightblue></td>');\r\n\t\t\t\t//removed: ' .$venues[$venue]. ' between '>' and 'Calendar'\r\n                //removed: show_week_no($week->get_id()). after '$week->get_name() .'\r\n    for ($i = 0; $i < 7; $i++)\r\n        echo ('<td class=\"dom\">' . get_dom($days[$i]) . '</td><td class=\"dow\">&nbsp; ' . $daynames[$i] . '</td>');\r\n    echo('<td bgcolor=lightblue></td></tr>');\r\n    $limit = 22;\r\n    for ($hour = 9; $hour < $limit; $hour++) {\r\n        echo (\"<tr><td class=\\\"hour\\\">\" . show_hours($venue, $hour) . \"</td>\");\r\n        for ($i = 0; $i < 7; $i++) {\r\n            $shiftid = $days[$i]->get_shift_id($hour);\r\n            if ($shiftid) {\r\n            \t$shift_length = get_shift_end($shiftid) - get_shift_start($shiftid);\r\n            \tif (substr($shiftid,9,5)==\"night\")\r\n            \t    $t=\"night\";\r\n            \telse $t = substr($shiftid,9,strrpos($shiftid,\":\")-9);\r\n          //  \techo \"shift id,length,start,end,t = \".$shiftid.\",\".$shift_length.\",\".get_shift_start($shiftid).\",\".get_shift_end($shiftid).\",\".$t;\r\n            \techo do_shift($days[$i], $t, $shift_length, $edit, $venue);\r\n                for ($j = $hour; $j < $hour + $shift_length; $j++)\r\n                    $free_hour[7 * ($j - 9) + $i] = false;\r\n            } \r\n            else \r\n            if ($free_hour[7 * ($hour - 9) + $i])\r\n                echo \"<td colspan='2' bgcolor=\\\"lightgray\\\"></td>\";\r\n        }\r\n        echo (\"<td class=\\\"hour\\\">\" . show_hours($venue, $hour) . \"</td></tr>\");\r\n    }\r\n\r\n\r\n// notes\r\n    echo do_day_notes($days, $edit, $year, $doy);\r\n    echo \"<input type=\\\"hidden\\\" name=\\\"_submit_check_edit_notes\\\" value=\\\"1\\\">\";\r\n    echo \"<input type=\\\"hidden\\\" name=\\\"weekid\\\" value=\\\"\" . $days[0]->get_id() . \"\\\">\";\r\n    echo \"</table>\";\r\n}\r\n\r\nfunction show_hours($venue, $hour) {\r\n    $d = 1;\r\n    $last_shift = 8;\r\n    if ($hour==21) {\r\n    \treturn \"night\";\r\n    }\r\n    else {\r\n    $clock = $hour < 12 ? $hour . \"am\" : $hour - 12 . \"pm\";\r\n    $clockend = $hour + $d < 12 ? ($hour + $d) . \"am\" : ($hour - 12 + $d) . \"pm\";\r\n    if ($clock == \"0pm\")\r\n        $clock = \"12pm\";\r\n    if ($clockend == \"0pm\")\r\n        $clockend = \"12pm\";\r\n    if (($clock) % $d == 0){\r\n    \tif ($clock % $last_shift == 0)\r\n            return $clock . \" - \" . $clockend;\r\n        else \r\n            return $clock;\r\n    }\r\n    else\r\n        return \"\";\r\n    }\r\n}\r\n\r\n// return a string of html that contains a table cell for a shift\r\nfunction do_shift($day, $shift, $length, $edit, $venue) {\r\n    // chooses size annd style of cell based on length\r\n    $s = \"<td colspan=\\\"2\\\" \";\r\n    $s = $s . \"rowspan='\" . $length . \"' class = 'shift'\";\r\n    // checks that the shift is not in the past\r\n    $year = date(\"Y\", time());\r\n    $doy = date(\"z\", time()) + 1;\r\n    if ($edit) // && ($year < $day->get_year() || $year == $day->get_year() && $doy <= $day->get_day_of_year() ))\r\n        $s = $s . \"e\";\r\n    $s = $s . \"\\\"><table id=\\\"shiftbox\\\"><tr><td class=\\\"persons\\\">\";\r\n    if ($edit) // && ($year < $day->get_year() || $year == $day->get_year() && $doy <= $day->get_day_of_year() ))\r\n        $s = $s . \"<a id=\\\"shiftlink\\\" href=\\\"editShift.php?shift=\" . substr($day->get_id(),0,8) . \":\" . $shift . \"&venue=\" . $venue . \"\\\">\";\r\n    $s = $s . get_people_for_shift($day, $shift);\r\n    if ($edit) { //&& ($year < $day->get_year() || $year == $day->get_year() && $doy <= $day->get_day_of_year() )) {\r\n        $s = $s . \"</a>\";\r\n        // if manager, adds shift notes\r\n        if ($_SESSION['access_level'] >= 2 || $_SESSION['access_level'] >= 1.5) {\r\n            $s = $s . \"</td></tr><tr><td class=\\\"notes\\\" align=\\\"center\\\">\" .\r\n                    \"<textarea id=\\\"shift_notes\\\" rows=\\\"1\\\" name=\\\"shift_notes_\" . $day->get_shift($shift)->get_id() . \"\\\">\"\r\n                    . $day->get_shift($shift)->get_notes() . \"</textarea>\";\r\n        } else {\r\n            $shiftnote = $day->get_shift($shift)->get_notes();\r\n            $s = $s . \"</td></tr><tr><td class=\\\"notes\\\"><p id=\\\"shift\\\">\" . $shiftnote . \"</p>\";\r\n        }\r\n    } \r\n    else {\r\n        $shiftnote = $day->get_shift($shift)->get_notes();\r\n        $s = $s . \"</td></tr><tr><td class=\\\"notes\\\"><p id=\\\"shift\\\">\" . $shiftnote . \"</p>\";\r\n    }\r\n    \r\n    $s = $s . \"</td></tr></table></td>\";\r\n    return $s;\r\n}\r\n\r\nfunction get_dom($day) {\r\n    $dom = $day->get_dom();\r\n    if (substr($dom, 0, 1) == \"0\")\r\n        return \"&nbsp;&nbsp;\" . substr($dom, 1);\r\n    return $dom;\r\n}\r\n\r\nfunction get_people_for_shift($day, $key) {\r\n\t//echo \"we are getting people for shift \".$day->get_shift($key);\r\n    $shift = $day->get_shift($key);\r\n    $people = $shift->get_persons();\r\n    if (!$people[0])\r\n        array_shift($people);\r\n    $p = \"<br>\";\r\n    $vac = $shift->num_vacancies();\r\n//\t\techo $shift->get_id().\" slots = \".$shift->num_slots().\"  vac = \".$shift->num_vacancies().\"<br>\";\r\n    for ($i = 0; $i < sizeof($people); ++$i) {\r\n        if (!$people[$i] == \"\") {\r\n            $name_components = explode(\"+\", $people[$i]);\r\n            $p = $p . \"&nbsp;\" . $name_components[1] . \" \" . $name_components[2] . \"<br>\";\r\n        }\r\n    }\r\n    if ($vac > 0)\r\n        $p = $p . \"&nbsp;<b>Vacancies (\" . $vac . \")</b>\";\r\n    return substr($p, 0, strlen($p) - 4);\r\n}\r\n\r\nfunction do_day_notes($days, $edit, $year, $doy) {\r\n    if ($edit == false || $_SESSION['access_level'] < 1.5) {\r\n        $s = \"<tr><td class=\\\"hour\\\">manager notes&nbsp;</td>\";\r\n        for ($i = 0; $i < 7; ++$i) {\r\n            $s = $s . \"<td class=\\\"note\\\" colspan=\\\"2\\\">\" . $days[$i]->get_mgr_notes() . \"</td>\";\r\n        }\r\n        return $s . \"<td class=\\\"hour\\\">manager notes&nbsp;</td></tr>\";\r\n    } else {\r\n        $s = \"<tr><td class=\\\"hour\\\">manager notes&nbsp;</td>\";\r\n        for ($i = 0; $i < 7; ++$i) {\r\n            if ($year < $days[$i]->get_year() || $year == $days[$i]->get_year() && $doy <= $days[$i]->get_day_of_year()) {\r\n                $s = $s . \"<td class=\\\"note_e\\\" colspan=\\\"2\\\"><textarea id=\\\"mgr_notes\\\"\r\n\t\t\t\t\t rows=\\\"1\\\" name=\\\"mgr_notes\" . $i . \"\\\">\"\r\n                        . $days[$i]->get_mgr_notes() . \"</textarea></td>\";\r\n            }\r\n            else \r\n                $s = $s . \"<td class=\\\"note\\\" colspan=\\\"2\\\">\" . $days[$i]->get_mgr_notes() . \"</td>\";\r\n        }\r\n        return $s . \"<td class=\\\"hour\\\">manager notes&nbsp;</td></tr>\";\r\n    }\r\n}\r\n\r\nfunction process_edit_notes($week, $venue, $post) {\r\n    $days = $week->get_dates();\r\n    for ($i = 0; $i < 7; ++$i) {\r\n        $shifts = $days[$i]->get_shifts();\r\n        foreach ($shifts as $key => $shift) {\r\n       //   if ($shift->get_venue()==$venue) {\r\n        \t$note = trim(str_replace('\\\"', '\\\\\\\"', str_replace('\\'', '\\\\\\'', htmlentities($post['shift_notes_' . $shift->get_id()]))));\r\n            $shift->set_notes($note);\r\n            update_dbShifts($shift);\r\n      //    }\r\n        }\r\n    //    if ($year < $days[$i]->get_year() || $year == $days[$i]->get_year() && $doy <= $days[$i]->get_day_of_year()) {\r\n            $mgr_note = trim(str_replace('\\\"', '\\\\\\\"', str_replace('\\'', '\\\\\\'', htmlentities($post['mgr_notes' . $i]))));\r\n            $days[$i] = select_dbDates($days[$i]->get_id());\r\n            $days[$i]->set_mgr_notes($mgr_note);\r\n            update_dbDates($days[$i]);\r\n    //    }\r\n        \r\n    }\r\n}\r\n?>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/calendar.inc b/calendar.inc
--- a/calendar.inc	
+++ b/calendar.inc	
@@ -90,7 +90,7 @@
     echo ('<table id="calendar" align="center" ><tr class="weekname"><td colspan="16" ' .
     'align="center" >Calendar: ' . $week->get_name() . '</td></tr>
 				<tr><td bgcolor=lightblue></td>');
-				//removed: ' .$venues[$venue]. ' between '>' and 'Calendar'
+			    //removed: ' .$venues[$venue]. ' between '>' and 'Calendar'
                 //removed: show_week_no($week->get_id()). after '$week->get_name() .'
     for ($i = 0; $i < 7; $i++)
         echo ('<td class="dom">' . get_dom($days[$i]) . '</td><td class="dow">&nbsp; ' . $daynames[$i] . '</td>');
